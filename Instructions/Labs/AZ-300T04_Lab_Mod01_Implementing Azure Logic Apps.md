---
lab:
    title: 'Azure ロジック・アプリを実装'
    module: 'モジュール 1: Azure App Service Web Apps の作成'
---

# アプリケーション サービスの実装と管理
# ラボ: Azure ロジック・アプリを実装
  
### シナリオ
  
アダタム コーポレーションは、リソース グループに対する変更のカスタム監視を実装したいと考えています。


### 目的
  
このモジュールを修了すると、次のことができるようになります:

-  Azure ロジック アプリを作成します 

-  Azure ロジック アプリと Azure イベント グリッドの統合を構成します

### ラボの設定
  
推定時間: 45 分間

ユーザー名: **受講者**

パスワード: **Pa55w.rd**


## エクササイズ 1: Azure ストレージ アカウントと Azure ロジック アプリで構成されるラボ環境を設定します 
  
このエクササイズの主なタスクは次のとおりです。

1. Azure 無料アカウントを作成します

1. Azure ロジック アプリを作成します 

1. Azure AD サービス原則の作成 

1. 閲覧者ロールを Azure AD サービス原則に割り当てます 

1. Microsoft.EventGrid リソース プロバイダーを登録します 


#### タスク 1: ストレージ アカウントを作成します

1. ラボのバーチャルマシンから Microsoft Edge を起動し、[**http://portal.azure.com**](http://portal.azure.com) で Azure ポータルを拾い読み し、ターゲット Azure サブスクリプションの所有者ロールを持つ Microsoft アカウントを使用してサインインします。
  
1. Azure portal から、次のパラメーターで新しい SQL データベースを作成してください: 

    - サブスクリプション: お客様の Azure サブスクリプションの名称

    - リソースグループ: **az3000701-LabRG** という名前の新しいリソースグループを作成します

    - ストレージ アカウント名: 小文字と数字で構成される 3 -24 文字の有効で独特な名前

    - 場所: サブスクリプションに使用でき、ラボの場所に最も近い Azure リージョンの名前

    - パフォーマンス: **Standard**

    - アカウント種類: **Storage (general purpose v1)**

    - レプリケーション: **ローカル冗長ストレージ (LRS)**

    - セキュアな転送が必要: **有効にする**

    - 仮想ネットワーク: **All networks**

    - 分層名前空間: **無効にする**

    > **注意**: デプロイメントが完了するのを待たずに、次のタスクに進みます。 


#### タスク 2: Azure ロジック アプリを作成します 
 
1. Azure Portal から、次の 設定で **ロジック アプリ** のインスタンスを作成します。

    - 名前: **logicapp3000701**

    - サブスクリプション: お客様の Azure サブスクリプションの名称

    - リソース グループ: 新しいリソース グループの名前 **az3000702-LabRG**

    - 場所: 前のタスクにストレージ アカウントをデプロイしたのと同じ Azure リージョン

    - Log Analytics: **Off**

1. アプリがプロビジョニングされるまで待ちます。これにはおよそ １ 分間かかります。 


#### タスク 3: Azure AD サービス原則の作成 

1. Azure portal に、Microsoft Edge ウィンドウに、 **Cloud Shell** 内に **PowerShell** セッションを開始します。 

1. **ストレージにマウントされたメッセージがない** というメッセージが表示された場合は、次の設定を使用してストレージを構成します。

    - サブシプション: ターゲット Azure サブスクリプションの名前

    - Cloud Shell リージョン: サブスクリプションに使用でき、ラボの場所に最も近い Azure リージョンの名前

    - リソース グループ: 新しいリソース グループの名前 **az3000700-LabRG**

    - ストレージ アカウント: 新しいストレージ アカウントの名前

    - ファイル共有: 新しいファイル共有の名前

1. 「Cloud Shell」ペインから、次の手順を実行して、このタスクの後続の手順に作成するサービス原則に関連付ける新しい Azure AD アプリケーションを作成します。

```pwsh
$password = 'Pa55w.rd1234'
$securePassword = ConvertTo-SecureString -Force -AsPlainText -String $password
$aadApp30007 = New-AzADApplication -DisplayName 'aadApp30007' -HomePage 'http://aadApp30007' -IdentifierUris 'http://aadApp30007' -Password $securePassword
```

1. Cloud Shell ペインから、次の手順を実行して、前の手順に作成したアプリケーションに関連付けられた新しい Azure AD サービス原則を作成します。

```pwsh
New-AzADServicePrincipal -ApplicationId $aadApp30007.ApplicationId.Guid
```

1. **New-AzADServicePrincipal** コマンドの出力に、**ApplicationId** プロパティの値をメモ します。このエクササイズには、次の操作が必要になります。

1. Cloud Shell ペインから、次の操作を実行して、 現在の Azure サブスクリプションの **Id** プロパティの値と、 そのサブスクリプションに関連付けられている Azure AD テナントの **TenantId** プロパティの値を識別します(このラボの次のエクササイズにも必要になります):

```pwsh
Get-AzSubscription
```

1. Cloud Shell ペインを閉じます。


#### タスク 4: 閲覧者ロールを Azure AD サービス原則に割り当てます 

1. Azure portal に、Azure サブスクリプションのプロパティを表示するブレードに移動します。 

1. Azure サブスクリプション ブレードに、 **アクセス コントロール (IAM)** をクリックします。

1. Azure サブスクリプションのスコープ内に **リーダー** ロールを **aadApp30007** サービス原則に割り当てます。


#### タスク 5: Microsoft.EventGrid リソース プロバイダーを登録します

1. Azure portal に、Microsoft Edge ウィンドウに、**Cloud Shell** 内の **PowerShell** セッションを再度開きます。 

1. Cloud Shell ペインから、次の操作を実行して、Microsoft.EventGrid リソース プロバイダーを登録します。

```pwsh
Register-AzResourceProvider -ProviderNamespace Microsoft.EventGrid
```

1. Cloud Shell ペインを閉じます。


> **結果**: このエクササイズを完了したら、ストレージ アカウントを作成し、次のエクササイズに構成するロジック アプリ、およびその構成中に参照する Azure AD サービス原則を作成しました。


## エクササイズ 2: Azure ロジック アプリを構成して、リソース グループに対する変更を監視します。
  
このエクササイズの主なタスクは次のとおりです。

1. Azure ロジック アプリにトリガーを追加します

1. Azure ロジック アプリにアクションを追加します

1. Azure ロジック アプリのコールバック URL を識別します

1. イベント サブスクリプションの構成

1. ロジック アプリをテストします


#### タスク 1: Azure ロジック アプリにトリガーを追加します

1. Azure portal に、 新しくプロビジョニングされた Azure ロジック アプリの **ロジック アプリ デザイナ** ブレードに移動します。

1. **空白のロジック アプリ** をクリックします。これにより、空白のデザイナ ワークスペースが作成され、ワークスペースに追加するコネクタとトリガの一覧が表示されます。

1. イベント **グリッド** トリガーを検索し、結果の一覧で、 **リソース イベントが発生したとき (プレビュー) Azure Event Grid トリガー** をクリックしてデザイナ ワークスペースに追加します。

1. **Azure イベント グリッド** タイルに、 **サービス原則との接続** リンクをクリックし、次の値を指定し、 **作成** をクリックします。

    - 接続名: **egc30007**

    - クライアント ID: 前のエクササイズに識別した **ApplicationId** プロパティ

    - クライアント秘密: **Pa55w.rd1234**

    - テナント: 前のエクササイズに識別した **TenantId** プロパティ

1. **リソース イベントが発生したとき** タイルに、次の値を指定します。

    - サブスクリプション: 前のエクササイズに識別したサブスクリプション **ID** プロパティ

    - リソースの種類: **Microsoft.Resources.resourceGroups**

    - リソース名: **/サブスクリプション/*サブスクリプションId*/resourceGroups/az3000701-LabRG**、 ***subscriptionId*** は前のエクササイズに識別したサブスクリプション **ID** プロパティです。

    - イベント タイプ アイテム - 1: **Microsoft.Resources.ResourceWriteSuccess**

    - イベント タイプ アイテム - 2: **Microsoft.Resources.ResourceDeleteSuccess**

1. **新規パラメータを追加** を クリックし、**サブスクリプション** 名を選択します。

1. **サブスクリプション名** テキスト ボックスに、**イベント-サブスクリプション-az3000701** を入力し、**保存**をクリックします。

#### タスク 2: Azure ロジック アプリにアクションを追加します

1. Azure portal に、新しくプロビジョニングされた Azure ロジック アプリのロジック アプリ デザイナ ブレードに **+ 新しいステップ** をクリックします。 

1. **アクションを選択** ウィンドウに、**検索コネクタとアクション** テキスト ボックスに **Outlook** と入力します。

1. 結果の一覧に、**Outlook.com** をクリックします。 

1. **Outlook.com** のアクションの一覧に、 **Outlook.com - 電子メールを送信** をクリックします。

1. **Outlook.com** ペインに、 **Sign in** をクリックします。 

1. プロンプトが表示された場合は、このラボに使用している Microsoft アカウントを使用して認証します。 

1. Outlook リソースにアクセスするための Azure ロジック アプリ アクセス許可を付与する同意を求めるメッセージが表示された場合は、**はい** をクリックします。

1. **電子メールの送信** ペインに、次の設定を指定し、**保存** をクリックします。

    - 宛先: Microsoft アカウントの名前

    - 件名: **リソース更新** を入力して、 **メールを送信** ペインの右側にある **動的コンテンツ** 列に **件名** をクリックします。

    - 本文: **リソース グループ と入力:** 、**電子メール 送信** のウィンドウ の右側にある **動的コンテンツ** 列の **トピック** を クリックし、**イベントタイプ:** 「 と入力: **電子メール送信** のウィンドウ] の右側にある **動的コンテンツ** 列に、 **イベントの種類** をクリックし、**イベント ID:** をクリックし、**電子メール 送信** のウィンドウ の右側にある **動的コンテンツ** 列で 、**ID** を クリック し、 **イベント時間:** と と入力: 右側の **動的コンテンツ** 列の **電子メール送信** のウィンドウの **イベントの時刻** をクリックします。


#### タスク 3: Azure ロジック アプリのコールバック URL を識別します

1. Azure portal に **logicapp3000701** ブレードに移動 し、**概要** セクションに **トリガー履歴を参照** をクリックします。**禁止エラー** メッセージを無視します。

1. **When_a_resource_event_occurs** ブレードに、**コールバック URL [POST]** テキスト ボックスの値をコピーします。


#### タスク 4: イベント サブスクリプションの構成

1. Azure portal に **az3000701-LabRG** リソース グループに移動し、垂直メニューに **イベント** をクリックします。

1. **az3000701-LabRG - Events** ブレードで、 **Getting Started** を選択し、 **Web Hook** をクリックします。

1. **イベント サブスクリプションの作成** ブレードで、**イベントの種類にフィルター** の ドロップ ダウン リストで、 **リソース書き込みサクセス** と **リソース削除サクセス** の隣にあるチェックボックスのみが 選択されていることを確保します。

1. **エンドポイント タイプ** ドロップダウン リストに、**Web フック** が選択されていることを確認し、 **エンドポイントを選択リンク** をクリックします。 

1. **Web フックの選択** ブレードに、 **サブスクライバ エンドポイント** に、 前のタスクにコピーした Azure ロジック アプリの **コールバック URL [POST]** の値を貼り付け、**選択の確認** をクリックします。

1. **イベント サブスクリプションの詳細** セクションの **名前** テキスト ボックスに、 **イベント-サブスクリプション-az3000701** を入力します。

1. **作成** をクリックします。


#### タスク 5: ロジック アプリをテストします 

1. Azure portal に、**az3000701-LabRG** リソース グループに移動し、垂直メニューで **概要** をクリックします。 

1. リソースの一覧に、最初のエクササイズに作成した Azure ストレージ アカウントをクリックします。

1. ストレージ アカウント ブレードに、垂直メニューで **構成** をクリックします。

1. 構成ブレードに、**セキュア転送必須** 設定を **無効**に設定し、**保存**をクリックします。

1. **logicapp3000701** ブレードに移動し、**更新** をクリックし、**実行履歴** には Azure ストレージ アカウントの構成変更に対応するエントリが含まれていることに注意してください。

1. このエクササイズに構成したメール アカウントの受信トレイに移動し、ロジック アプリによって生成されたメールが含まれていることを確認します。

> **結果**: このエクササイズを完了したら、リソース グループの変更を監視する Azure ロジック アプリを構成しました。


## 演習 3: ラボリソースを削除

#### タスク 1：Cloud Shell を開く

1. ポータルの上部にある **Cloud Shell** アイコンをクリックして、Cloud Shell ペインを開きます。

1. 必要に応じて、Cloud Shell ペインの左上隅にあるドロップ ダウン リストを使用して、Bash シェル セッションに切り替えます。

1. **「Cloud Shell」** コマンドプロンプトで、次のコマンドを入力し、**「Enter」** キーを押して、このラボで作成したすべてのリソース グループを一覧表示します。

```
   az group list --query "[?starts_with(name,'az30007')]".name --output tsv
```

1. 出力に、この実習ラボで作成したリソース グループのみが含まれていることを確認します。これらのグループは、次のタスクで削除されます。

#### タスク 2: リソース グループの削除

1. **Cloud Shell** コマンド プロンプトで、次のコマンドを入力し、**Enter** キーを押してこのラボで作成したリソース グループを削除します:

```sh
   az group list --query "[?starts_with(name,'az30007')]".name --output tsv | xargs -L1 bash -c 'az group delete --name $0 --no-wait --yes'
```

1. ポータルの下部にある **Cloud Shell** プロンプトを閉じます。

> **結果**: このエクササイズでは、このラボで使用するリソースを削除しました。
