---
lab:
    title: 'Azure Storage アクセス制御の実装'
    module: 'モジュール 1: コンピューティングおよびストレージ ソリューションの選択'
---

# ストレージの実装と管理
# ラボ: Azure Storage アクセス制御の実装
  
### シナリオ
  
アダタムコーポレーションは、Azure Storage に存在するコンテンツを保護したいと考えています。


### 目的
  
このラボが完了すると、次のことができるようになります:

-  Azure Storage account アカウントを作成する

-  データを Azure Storage にアップロードする

-  Azure Storage アクセス制御の実装

### ラボのセットアップ
  
予定時刻: 30 分間

ユーザー名：**Student**

パスワード: **Pa55w.rd**


## エクササイズ 1: Azure Storage アカウントの作成および接続。
  
このエクササイズの主なタスクは次のとおりです:

1. Azure でストレージ アカウントを作成する。

1. ストレージ アカウントのプロパティを表示する 


#### タスク 1: Azure でストレージ アカウントを作成する。

1. ラボの仮想マシンから Microsoft Edge を起動し、[**http://portal.azure.com**](http://portal.azure.com) で Azure Portalを参照 し、ターゲット Azure サブスクリプションの所有者ロールを持つ Microsoft アカウントを使用することでサインインします。
  
1. Azure Portal から、次のパラメーターで新しいストレージ アカウントを作成してください: 

    - サブスクリプション：ターゲット Azure サブスクリプションの名称

    - リソースグループ:**az3000201-LabRG** という名のリソースグループを作成する

    - ストレージ アカウント名: 小文字と数字で構成される 3 ~ 24 文字の有効な一意な名前

    - 場所: サブスクリプションで使用でき、ラボの場所に最も近い Azure リージョンの名前

    - パフォーマンス：**標準**

    - アカウント種類：**ストレージ(汎用v1)**

    - レプリケーション：**ローカル冗長ストレージ (LRS)**
    
    - 安全な転送が必須: **無効**

    - 仮想ネットワーク：**すべてのネットワーク**
    
    - BLOB の論理的な削除: **無効**

    - 階層構造の名前空間: **無効**

1. ストレージ アカウントがプロビジョニングされるのを待ちます。これにはおよそ 1 分ほどかかります。


#### タスク 2: ストレージ アカウントのプロパティを表示する
  
1. Azure Portal で、ストレージ アカウント ブレードを開いたまま、場所、レプリケーション、パフォーマンスの設定など、**概要** セクションを確認します。

1. **アクセス キー** ブレードを表示します。アクセス・キー・ブレードでは、key1 と key2 を含むストレージ・アカウント名の値をコピーするオプションがあることに注意してください。また、両方のキーを再生成することもできます。

1. **構成** ブレードを表示します。

1. **構成** ブレードで、**汎用 v2** アカウントへのアップグレードを実行 し、レプリケーション設定を変更するオプションがあること注意してください。ただし、パフォーマンス設定を変更することはできません (これは、ストレージ アカウントの作成時にのみ割り当てることができます)。

> **結果**: このエクササイズ を完了すると、Azure Storage を作成し、そのプロパティを調べます。


## エクササイズ 2: Ｂlob の作成と管理
  
このエクササイズの主なタスクは次のとおりです:

1. コンテナーの作成

1. Azure Portal を使用してコンテナーにデータをアップロードする

1. SAS トークンを使用することで Azure Storage アカウントのコンテンツにアクセスする


#### タスク 1: コンテナーの作成
  
1. Azure Portal で、前のタスクで作成したストレージ アカウントのプロパティを表示するブレードに移動します。

1. ストレージ アカウントのブレードで次の設定で新しい blob コンテナーを作成してください：

    - 名前: **ラボコンテナー**

    - アクセスの種類: **プライベート**


#### タスク 2: Azure Portal を使用してコンテナーにデータをアップロードする
  
1. Azure Portal で、**ラボコンテナ** ブレードに移動します。

1. **ラボコンテナー** ブレードから、ファイルをアップロードします。**C:\\Windows\\ImmersiveControlPanel\\images\\splashscreen.contrast-white_scale-400.png**。  


#### タスク 3: SAS トークンを使用することで Azure Storage アカウントのコンテンツにアクセスする
  
1. **ラボコンテナ** ブレードから、新しくアップロードされた BLOB の URL を識別します。 

1. Microsoft Edge を起動し、その URL に移動します。

1. **ResourceNotFound** エラー メッセージに注意してください。これは、BLOB 認証アクセスが必要なプライベート コンテナーに存在すると期待されるためです。 

1. Azure Portal を表示する Microsoft Edge ウィンドウに切 り替え、**splashscreen.contrast-white_scale-400.png** ブレードで **SAS の生成** タブに切り替 えます。 

1. **SAS の生成** タブで **HTTP** オプションを有効に し、BLOB SAS トークンと対応する URL を生成します。

1. 新しい Microsoft Edge ウィンドウを開き、前の手順で生成された URL に移動します。

1. 画像を表示できることに注意してください。これは、URL に含まれる SAS トークンに基づいて BLOB にアクセスする権限が与えられたため、この時点で必要です。 

1. イメージを表示する Microsoft Edge ウィンドウを閉じます。


#### タスク 4: SAS トークンと保存されているアクセス ポリシーを使用して、Azure Storage アカウントのコンテンツにアクセスします。

1. Azure Portal で、**ラボコンテナ** ブレードに移動します。

1. **ラボコンテナー** ブレードから、 **ラボコンテナ -アクセスポリシー** ブレードに移動します。

1. 次の設定に新しいポリシーを追加する:

    - 識別子: **ラボコンテナー読** み取り

    - アクセス許可: **読み取り**

    - 開始時刻: 現在の日付と時刻

    - 有効期限: 現在の日付と時刻 + 24 時間

1. Azure portal で、Microsoft Edge ウィンドウで、 **Cloud Shell** 内で **PowerShell** セッションを開始します。 

1. **ストレージにマウントされたメッセージがない** というメッセージが表示された場合は、次の設定を使用し、ストレージを構成します。

    - サブシプション: ターゲット Azure サブスクリプションの名前

    - Cloud Shell リージョン: サブスクリプションで使用でき、ラボの場所に最も近い Azure リージョンの名前

    - リソース グループ: **az3000201-LabRG**

    - ストレージ アカウント: 新しいストレージ アカウントの名前

    - ファイル共有: 新しい共有ファイルの名前

1. Cloud Shell パネルから、次の操作を実行し、このエクササイズの最初のエクササイズで作成したストレージ アカ保存します。

```pwsh
   $storageAccount = (Get-AzStorageAccount -ResourceGroupName az3000201-LabRG)[0]
```

1. Cloud Shell パネルから、次の操作を実行して、ストレージ アカウントに完全な制御を許可するセキュリティ コンテキストを実行します。

```pwsh
   $keyContext = $storageAccount.Context
```

1. Cloud Shell パネル、前のタスクで作成したアクセス ポリシーに基づいて BLOB 固有の SAS トークンを作成するには、次の操作を実行します。

```pwsh
   $sasToken = New-AzStorageBlobSASToken -Container 'labcontainer' -Blob 'splashscreen.contrast-white_scale-400.png' -Policy labcontainer-read -Context $keyContext
```

1. Cloud Shell パネルから、新しく作成された SAS トークンに基づいてセキュリティ コンテキストを確立するには、次の操作を実行します。 

```pwsh
   $sasContext = New-AzStorageContext $storageAccount.StorageAccountName -SasToken $sasToken
```

1. Cloud Shell パネルから、次の操作を実行して、BLOB のプロパティを取得します。 

```pwsh
   Get-AzStorageBlob -Container 'labcontainer' -Blob 'splashscreen.contrast-white_scale-400.png' -Context $sasContext
```

1. BLOB に正常にアクセスしたことを確認します。

1. Cloud Shell パネルを最小化します。


#### タスク 5: アクセス ポリシーを変更することで、SAS トークンを無効にします。

1. Azure Portal で、**ラボコンテナー - アクセス ポリシー** ブレードに移動します。

1. 開始 時刻と有効期限を昨日の日付に設定し、**既存のポリシーラボコンテナー読み取りを編集します**。 

1. Cloud Shell パネルを再度開きます。 

1. Cloud Shell パネルから、次の操作を再実行して、BLOB のプロパティの取得を試みます。 

```pwsh
   Get-AzStorageBlob -Container 'labcontainer' -Blob 'splashscreen.contrast-white_scale-400.png' -Context $sasContext
```

1. もうこれ以上BLOB にアクセスできないを確認します。


> **結果**: このエクササイズを完了したら、BLOB コンテナーを作成し、そのコンテナーにファイルをアップロードし、SAS トークンと格納されたアクセス ポリシーを使用することでアクセス制御をテストしました。

## 演習 3: ラボリソースを削除

#### タスク 1：Cloud Shell を開く

1. ポータルの上部にある **Cloud Shell** アイコンをクリックして、Cloud Shell ペインを開きます。

1. 必要に応じて、Cloud Shell ペインの左上隅にあるドロップ ダウン リストを使用して、Bash シェル セッションに切り替えます。

1. **「Cloud Shell」** コマンドプロンプトで、次のコマンドを入力し、**「Enter」** キーを押して、このラボで作成したすべてのリソース グループを一覧表示します。

```
   az group list --query "[?starts_with(name,'az30002')]".name --output tsv
```

1. 出力に、この実習ラボで作成したリソース グループのみが含まれていることを確認します。これらのグループは、次のタスクで削除されます。

#### タスク 2: リソース グループの削除

1. **Cloud Shell** コマンド プロンプトで、次のコマンドを入力し、**Enter** キーを押してこのラボで作成したリソース グループを削除します:

```sh
   az group list --query "[?starts_with(name,'az30002')]".name --output tsv | xargs -L1 bash -c 'az group delete --name $0 --no-wait --yes'
```

1. ポータルの下部にある **Cloud Shell** プロンプトを閉じます。

> **結果**: このエクササイズでは、このラボで使用するリソースを削除しました。
